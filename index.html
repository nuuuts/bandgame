<html>
<head>
	<title>The Band Game</title>
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<style>
		body { font-family: 'Droid Serif Pro', 'Garamond', 'Georgia', 'Lucida Serif', serif; font-size: 125%; }
		div.band-list-by-letter { display: inline-block; vertical-align: top; padding: 0.5em; min-width: 7em; }
		/* div.band-list-by-letter:nth-of-type(odd) { maybe something } */
		div.band-list-by-letter ul { padding-left: 1em; }
		.player1 { color: #1f77b4; }
		.player2 { color: #ff7f0e; }
		.player3 { color: #2ca02c; }
		.player4 { color: #d62728; }
		.player5 { color: #9467bd; }
		.player6 { color: #8c564b; }
		.player7 { color: #e377c2; }
		.player8 { color: #7f7f7f; }
		.player_bg1 { background-color: #1f77b4; }
		.player_bg2 { background-color: #ff7f0e; }
		.player_bg3 { background-color: #2ca02c; }
		.player_bg4 { background-color: #d62728; }
		.player_bg5 { background-color: #9467bd; }
		.player_bg6 { background-color: #8c564b; }
		.player_bg7 { background-color: #e377c2; }
		.player_bg8 { background-color: #7f7f7f; }

		input#band-game-search { width: 95%; font-size: 200%; margin: 0.5em 0.5em; padding: 0.25em; }
		label#current-letter { font-style: italic; color: black;}
		button#help-button { display: block; position: absolute; top: 1em; right: 2em;}
		div#save-load { margin-bottom: 1em; }
		div#edit-players { display: inline; }
		div#help { display: none; position: absolute; top: 3em; left: 0em; ; padding: 1em; background: white; border: 1px solid black; }
	</style>
</head>
<body>
<h1>The Band Game</h1>
<button id='help-button'>?</button>

<div id="help">
	<p>
		<b>The Band Game</b> is an easy and fun way to spend time with friends on road/ferry/plane trips.
	</p>
	<p>
		<b>Rules</b> of the game are simple: 
		<ol type='1'>
			<li>Come up with a name of a band that you for sure know exists.</li>
			<li>Same as above, but starting with the last letter of the previous band</li>
		</ol>
		<b>Example chain:</b><br/>
		Embreac<i>h</i> -> <b>H</b>elevor<i>n</i> -> <b>N</b>e Obliviscari<i>s</i> ... and so on.
	</p>
	<p>
		That's it!
	</p>
	<p>
		<b>Optional house rules:</b>
		<ul>
			<li>If no one can come up with any bands starting with a given letter, it may be deemed a wildcard letter and any band can be named next</li>
			<li>A time limit of some sort may be applied to keep the ball rolling.</li>
			<li>Try to fill up your entire alphabet with at least one artist.</li>
			<li>If an artist performs under the names "Artist" and "Artist and the Bandnames" both are expended upon the first being used, e.g. <i>John Doe</i> vs <i>John Doe and the Anonymous</i>.</li>
		</ul>
	</p>
</div>
<div id="save-load">
		<button id="save-game">Save game</button> | <button id="load-game">Load game</button> | <button id="new-game">New game</button>
</div>
<div id="player-controls">
	<label>Players (<label id="playercount"></label>)
	<input type="text" id="players" />
</div>
<div id="history">
	<ol></ol>
</div>
<h2><label id="current-player">Player </label>: <label id="current-letter"></label></h2>
<div id="game-input-search">
	<input 
		type="search" 
		id="band-game-search"
		autocomplete="no"
		autocorrect="off"
		autocapitalize="off"
		spellcheck={false}
		/>
</div>
<h2>Used bands (<label id='band-count'></label>)</h2>
<div id="used-bands">
</div>
<template id="band-letter-block">
	<div class="band-list-by-letter">
		<h3></h3>
		<ul></ul>
	</div>
</template>
</body>
	<script>
		
		var currentLetter = 'free choice';
		var currentPlayer = 0;
		var bandsByLetter = {};
		var bandChain = [];
		var players = [];

		function setCurrentLetter(letter) {
			currentLetter = letter;
			showCurrentLetter();
		}
		function showCurrentLetter() {
			document.querySelector('#current-letter').innerText = currentLetter;
		}

		function setPlayers() {
			document.querySelector('#playercount').innerText = players.length;
			document.querySelector('#players').value = players.join(' ');
		}

		function setCurrentPlayer() {
			currentPlayer = (bandChain.length % players.length);
			showCurrentPlayer();
		}
		function showCurrentPlayer() {
			let player = document.querySelector('#current-player');
			if (players.length > 0) {
				player.innerText = players[currentPlayer];
			} else {
				player.innerText = 'solo game'
			}
			player.className = `player${currentPlayer+1}`;
			
		}

		function showBandHistory() {
			let histContainer = document.querySelector('#history ol');
			let totalBands = bandChain.length;
			let latestBands = []
			if (totalBands > 0) {
				let bandsToShow = Math.min(totalBands, 3)
				let startCount = totalBands - bandsToShow;
				histContainer.setAttribute('start', startCount + 1);
				latestBands = bandChain.slice(startCount);
				histContainer.innerHTML = '';
				for (let band of latestBands) {
					let li = document.createElement('li');
					li.innerText = band;
					li.className = classForBand(band);
					histContainer.appendChild(li);
				}
			}
		}
		function init() {
			refreshBands();
			showCurrentLetter();
			showCurrentPlayer();
			setPlayers();
		}
		window.onload = init;

		document.querySelector('#band-game-search').onkeyup = (keyEvent) => {
			// console.log(keyEvent);
			if (keyEvent.key == "Enter") {
				var band = keyEvent.target.value.toLowerCase();
				var bandIndex = bandChain.indexOf(band);
				if (bandIndex >= 0) {
					if (bandIndex == 0) {
						alert(band + " was the first one played!");
					} else {
						alert(band + " was played already after " + bandChain[bandIndex - 1]);
					}
				} else {
					addBand(band);
					keyEvent.target.value = '';
				}
			}
		}

		document.querySelector('#players').onkeyup = (keyEvent) => {
			// console.log(keyEvent);
			if (keyEvent.key == "Enter") {
				console.log(`Full player input: <<${keyEvent.target.value.trim()}>>`);
				let newPlayers = keyEvent.target.value.trim().split(' ');
				console.log("newPlayers", newPlayers);
				let oldCount = players.length;
				players = newPlayers;
				setPlayers();
				setCurrentPlayer();
				if (newPlayers.length != oldCount) {
					refreshBands();
				}
			}
		}

		function addBand(name) {
			name = name.toLowerCase();
			bandChain.push(name);
			var first = name.slice(0,1);
			var last = name.slice(-1);
			if (first in bandsByLetter) {
				bandsByLetter[first].push(name);
			} else {
				bandsByLetter[first] = [name];
			}
			setCurrentLetter(last);
			setCurrentPlayer();
			refreshBands();
		}

		function classForBand(bandName) {
			let bandIndex = bandChain.indexOf(bandName);
			let nthPlayer = (bandIndex % players.length) + 1;
			return `player${nthPlayer}`;

		}
		function refreshBands() { 
			var template = document.querySelector('#band-letter-block');
			var container = document.querySelector('#used-bands');
			var freshContainer = container.cloneNode(false);
			container.parentNode.replaceChild(freshContainer, container);
			
			document.querySelector('#band-count').innerText = bandChain.length;
			
			Object.keys(bandsByLetter).sort().forEach((letter) => {
				// console.log('showing bands of letter', letter)
				var letterBlock = document.importNode(template.content, true);
				letterBlock.querySelector('h3').innerText = letter.toUpperCase() + " (" + bandsByLetter[letter].length + ")";
				bandsByLetter[letter].sort().forEach((band) => {
					let li = document.createElement('li');
					li.className = classForBand(band);
					li.innerText = band;
					letterBlock.querySelector('ul').appendChild(li);
				});
				freshContainer.appendChild(letterBlock);
			});
			showBandHistory();
			setCurrentPlayer();
		}

		document.querySelector('#save-game').onclick = () => {
			for (let variable of ['bandChain', 'bandsByLetter', 'currentLetter', 'players']) {
				localStorage.setItem('bandgame.' + variable, JSON.stringify(window[variable]));
			}
			alert('Game successfully saved to your local browser.')
		};
		document.querySelector('#load-game').onclick = () => {
			for (let variable of ['bandChain', 'bandsByLetter', 'currentLetter']) {
				let value = JSON.parse(localStorage.getItem('bandgame.' + variable));
				if (value == null) {
					alert('Loading failed from storage. Please start a new game.');
					break;
				}
				window[variable] = value;
			}
			init();
		}

		document.querySelector('#new-game').onclick = () => {
			window.location.href = window.location.href;
		}

		document.querySelector('#help-button').onclick = () => {
			let help = document.querySelector('div#help');

			if (window.getComputedStyle(help, null).display == 'none') {
				help.style.display = 'block';
			} else {
				help.style.display = 'none';
			}
		}
		
	</script>
</html>
