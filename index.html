<html>
<head>
	<title>The Band Game</title>
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<style>
		body { font-family: 'Droid Serif Pro', 'Garamond', 'Georgia', 'Lucida Serif', serif; font-size: 110%; }
		div.band-list-by-letter { display: inline-block; vertical-align: top; padding: 0.5em; min-width: 7em; }
		/* div.band-list-by-letter:nth-of-type(odd) { maybe something } */
		div.band-list-by-letter ul { padding-left: 1em; }
		.player1 { color: #1f77b4; }
		.player2 { color: #ff7f0e; }
		.player3 { color: #2ca02c; }
		.player4 { color: #d62728; }
		.player5 { color: #9467bd; }
		.player6 { color: #8c564b; }
		.player7 { color: #e377c2; }
		.player8 { color: #7f7f7f; }
		.player_bg1 { background-color: #1f77b4; }
		.player_bg2 { background-color: #ff7f0e; }
		.player_bg3 { background-color: #2ca02c; }
		.player_bg4 { background-color: #d62728; }
		.player_bg5 { background-color: #9467bd; }
		.player_bg6 { background-color: #8c564b; }
		.player_bg7 { background-color: #e377c2; }
		.player_bg8 { background-color: #7f7f7f; }

		input#band-game-search { width: 75%; font-size: 200%; margin: 0.5em 0.5em; padding: 0.25em; }
		label#current-letter { font-style: italic; color: black;}
		button#help-button { display: block; position: absolute; top: 1em; right: 2em;}
		div#save-load { margin-bottom: 1em; }
		div#edit-players { display: inline; }
		h2#used-bands-heading { margin-bottom: 0.25em; }
		button#save-game { display: none }
		div#autosave { font-size: 75%; color: gray; margin-top: 0; }
		div#help { display: none; position: absolute; top: 3em; left: 0em; ; padding: 1em; background: white; border: 1px solid black; }
	</style>
</head>
<body>
<h1>The Band Game</h1>
<button id='help-button'>?</button>

<div id="help">
	<p>
		<b>The Band Game</b> is an easy and fun way to spend time with friends on road/ferry/plane trips.
	</p>
	<p>
		<b>Rules</b> of the game are simple: 
		<ol type='1'>
			<li>Come up with a name of a band that you for sure know exists.</li>
			<li>Same as above, but starting with the last letter of the previous band</li>
		</ol>
		<b>Example chain:</b><br/>
		Embreac<i>h</i> -> <b>H</b>elevor<i>n</i> -> <b>N</b>e Obliviscari<i>s</i> ... and so on.
	</p>
	<p>
		That's it!
	</p>
	<p>
		<b>Optional house rules:</b>
		<ul>
			<li>If no one can come up with any bands starting with a given letter, it may be deemed a wildcard letter and any band can be named next</li>
			<li>A time limit of some sort may be applied to keep the ball rolling.</li>
			<li>Try to fill up your entire alphabet with at least one artist.</li>
			<li>If an artist performs under the names "Artist" and "Artist and the Bandnames" both are expended upon the first being used, e.g. <i>John Doe</i> vs <i>John Doe and the Anonymous</i>.</li>
		</ul>
	</p>
</div>
<div id="save-load">
		<button id="save-game">Save game</button>
		<button id="load-game">Load game</button> | 
		<button id="new-game">New game</button> | 
		<button id="share-game">Share game</button>

</div>
<div id="player-controls">
	<label>Players (<label id="playercount"></label>)
	<input type="text" id="players" />
</div>
<div id="history">
	<ol></ol>
</div>
<h2><label id="current-player">Player </label>: <label id="current-letter"></label></h2>
<div id="game-input-search">
	<input 
		type="text" 
		id="band-game-search"
		autocomplete="no"
		autocorrect="off"
		autocapitalize="off"
		spellcheck={false}
		/>
</div>
<h2 id="used-bands-heading">Used bands (<label id='band-count'></label>)</h2>
<div id="autosave"></div>
<div id="used-bands">
</div>
<template id="band-letter-block">
	<div class="band-list-by-letter">
		<h3></h3>
		<ul></ul>
	</div>
</template>
</body>
	<script>
		
		var currentLetter = 'free choice';
		var currentPlayer = 0;
		var bandsByLetter = {};
		var bandChain = [];
		var players = [];

		function setCurrentLetter(letter) {
			currentLetter = letter;
			showCurrentLetter();
		}
		function showCurrentLetter() {
			document.querySelector('#current-letter').innerText = currentLetter;
		}

		function setPlayers() {
			document.querySelector('#playercount').innerText = players.length;
			document.querySelector('#players').value = players.join(' ');
		}

		function setCurrentPlayer() {
			currentPlayer = (bandChain.length % players.length);
			showCurrentPlayer();
		}
		function showCurrentPlayer() {
			let player = document.querySelector('#current-player');
			if (players.length > 0) {
				player.innerText = players[currentPlayer];
			} else {
				player.innerText = 'solo game'
			}
			player.className = `player${currentPlayer+1}`;
			
		}

		function showBandHistory() {
			let histContainer = document.querySelector('#history ol');
			let totalBands = bandChain.length;
			let latestBands = []
			if (totalBands > 0) {
				let bandsToShow = Math.min(totalBands, 3)
				let startCount = totalBands - bandsToShow;
				histContainer.setAttribute('start', startCount + 1);
				latestBands = bandChain.slice(startCount);
				histContainer.innerHTML = '';
				for (let band of latestBands) {
					let li = document.createElement('li');
					li.innerText = band;
					li.className = classForBand(band);
					histContainer.appendChild(li);
				}
			}
		}

		// H4sIAAAAAAAACh3MQQqAIBRF0b3c8V9BWwkHTxNUSiINiWjvUeMD5yYk5co0I%2B%2BFIR8wwhIx4rafHaNr0W%2B5KKk2jCZ1VeGMfdUVj%2FYdaWCUgXteg%2FpB9VkAAAA%3D
		// H4sIAAAAAAAACqtWSs5IzMxTsopWKs7PyVfSUSrOV0jPz09RitVRKshJrEwtKlayio6tBQAapxA7KQAAAA%3D%3D

		async function shareGame() {
			const state = {
				chain: bandChain,
				players: players,
			}
			const json = JSON.stringify(state);
			console.log('JSON state: ', json.length, 'bytes')
			const buffer = await compress(json);
			console.log('Buffer size after compression: ', buffer.length);
			const b64 = btoa(String.fromCharCode(...buffer));
			console.log('b64 size: ', b64.length);
			const payload = encodeURIComponent(b64);
			console.log('Payload', payload);
			window.location.hash = payload;
			await navigator.clipboard.writeText(window.location.href);
			alert('Link copied to clipboard!');
		}

		async function compress(str) {
			const stream = new Blob([str]).stream();
			const compressedStream = stream.pipeThrough(
				new CompressionStream('gzip')
			);
			const chunks = [];
			for await (const chunk of compressedStream) {
				chunks.push(chunk);
			}
			const blob = new Blob(chunks);
			const buffer = await blob.arrayBuffer();
			return new Uint8Array(buffer);
		}

		async function decompress(compressedBytes) {
			const stream = new Blob([compressedBytes]).stream();
			const decompressedStream = stream.pipeThrough(
				new DecompressionStream("gzip")
			);
			const chunks = [];
			for await (const chunk of decompressedStream) {
				chunks.push(chunk);
			}
			const blob = new Blob(chunks);
			const buffer = await blob.arrayBuffer();
			return new Uint8Array(buffer);
		}

		async function readSharedState() {
			console.log('readSharedState')
			const b64 = decodeURIComponent(location.hash.slice(1));
			const bin = atob(b64);
			// console.log(bin);
			const compressedBytes = Uint8Array.from(bin, c => c.charCodeAt(0));
			const payload = await decompress(compressedBytes);
			const json = new TextDecoder().decode(payload);
			const shared_state = JSON.parse(json)
			console.log('Shared state read: ', json);
			shared_chain = shared_state['chain'];
			players = shared_state['players'];
			console.log('Total of ', shared_chain.length, 'bands in chain');
			for (let band of shared_chain) {
				console.log('addBand', band, 'no autosave!')
				addBand(band, false);
			}
			saveGame();
			history.replaceState(null, '', location.pathname);


		}

		async function loadOrInitGame() {
			const canCompress = ('CompressionStream' in window) && ('DecompressionStream' in window);
			if (!canCompress) { 
				console.warn('no CompressionStream capability')
				document.querySelector('#share-game').disabled = true;
			} else {
				console.log('CompressionStream capable!')
				document.querySelector('#share-game').onclick = shareGame;
				if (window.location.hash) {
					console.log('Share detected')
					if (confirm('Detected shared state in URL. Do you want to overwrite current state with it?')) {
						console.log('Reading state');
						await readSharedState();
					}
				} else {
						console.log('No shared state')
						let savedGame = localStorage.getItem('bandgame');
						if (savedGame) {
							console.log('Save game detected', savedGame);
							// alert(`Loading saved game from ${savedGame}`);
							loadGame();
							console.log('Load game finished..');
							document.querySelector('#autosave').innerText = `Save game loaded: ${savedGame}`;
							return;
						} else {
							console.log('No save game detected');
						}
					}
				}
			init();
		}

		function init() {
			console.log('init')
			refreshBands();
			showCurrentLetter();
			showCurrentPlayer();
			setPlayers();
		}

		window.onload = loadOrInitGame;

		document.querySelector('#band-game-search').onkeyup = (keyEvent) => {
			// console.log(keyEvent);
			if (keyEvent.key == "Enter") {
				var band = keyEvent.target.value.toLowerCase();
				var bandIndex = bandChain.indexOf(band);
				if (bandIndex >= 0) {
					if (bandIndex == 0) {
						alert(band + " was the first one played!");
					} else {
						alert(band + " was played already after " + bandChain[bandIndex - 1]);
					}
				} else {
					addBand(band);
					keyEvent.target.value = '';
				}
			}
		}

		document.querySelector('#players').onkeyup = (keyEvent) => {
			// console.log(keyEvent);
			if (keyEvent.key == "Enter") {
				console.log(`Full player input: <<${keyEvent.target.value.trim()}>>`);
				let newPlayers = keyEvent.target.value.trim().split(' ');
				console.log("newPlayers", newPlayers);
				let oldCount = players.length;
				players = newPlayers;
				setPlayers();
				setCurrentPlayer();
				if (newPlayers.length != oldCount) {
					refreshBands();
				}
			}
		}

		function addBand(name, autosave=true) {
			name = name.toLowerCase();
			bandChain.push(name);
			var first = name.slice(0,1);
			var last = name.slice(-1);
			if (first in bandsByLetter) {
				bandsByLetter[first].push(name);
			} else {
				bandsByLetter[first] = [name];
			}
			setCurrentLetter(last);
			setCurrentPlayer();
			refreshBands();
			if (autosave) {
				saveGame();
			}
		}

		function classForBand(bandName) {
			let bandIndex = bandChain.indexOf(bandName);
			let nthPlayer = (bandIndex % players.length) + 1;
			return `player${nthPlayer}`;

		}
		function refreshBands() { 
			var template = document.querySelector('#band-letter-block');
			var container = document.querySelector('#used-bands');
			var freshContainer = container.cloneNode(false);
			container.parentNode.replaceChild(freshContainer, container);
			
			document.querySelector('#band-count').innerText = bandChain.length;
			
			Object.keys(bandsByLetter).sort().forEach((letter) => {
				// console.log('showing bands of letter', letter)
				var letterBlock = document.importNode(template.content, true);
				letterBlock.querySelector('h3').innerText = letter.toUpperCase() + " (" + bandsByLetter[letter].length + ")";
				bandsByLetter[letter].sort().forEach((band) => {
					let li = document.createElement('li');
					li.className = classForBand(band);
					li.innerText = band;
					letterBlock.querySelector('ul').appendChild(li);
				});
				freshContainer.appendChild(letterBlock);
			});
			showBandHistory();
			setCurrentPlayer();
		}

		async function saveGame() {
			for (let variable of ['bandChain', 'bandsByLetter', 'currentLetter', 'players']) {
				localStorage.setItem('bandgame.' + variable, JSON.stringify(window[variable]));
			}
			localStorage.setItem('bandgame', (new Date()).toISOString());

			document.querySelector('#autosave').innerText = `Saved ${(new Date()).toISOString()}`;
		}
		document.querySelector('#save-game').onclick = saveGame;

		function loadGame() { 
			for (let variable of ['bandChain', 'bandsByLetter', 'currentLetter', 'players']) {
				let value = JSON.parse(localStorage.getItem('bandgame.' + variable));
				if (value == null) {
					if (variable == "players") {
						alert('New feature: set your player names at the top! Setting default for now.');
						value = ['player1', 'player2'];
					} else {
						alert('Loading failed from storage. Please start a new game.');
						break;
					}
				}
				window[variable] = value;
			}
			init();
			let savedGame = localStorage.getItem('bandgame');
			if (savedGame) {
				document.querySelector('#autosave').innerText = `Save game loaded: ${savedGame}`;
			}
		}
		document.querySelector('#load-game').onclick = loadGame;
		
		document.querySelector('#new-game').onclick = () => {
			for (let variable of ['bandChain', 'bandsByLetter', 'currentLetter', 'players']) {
				localStorage.removeItem(`bandgame.${variable}`);
			}
			localStorage.removeItem(`bandgame`);

			window.location.href = window.location.href;
		}

		document.querySelector('#help-button').onclick = () => {
			let help = document.querySelector('div#help');

			if (window.getComputedStyle(help, null).display == 'none') {
				help.style.display = 'block';
			} else {
				help.style.display = 'none';
			}
		}
		
	</script>
</html>
